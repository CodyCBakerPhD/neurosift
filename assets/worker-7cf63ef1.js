(function(){"use strict";let d,f,h;onmessage=function(e){e.data.canvas!==void 0&&(d=e.data.canvas,g()),e.data.opts!==void 0&&(f=e.data.opts,g()),e.data.plotData!==void 0&&(h=e.data.plotData,g())};function y(e,s){let a=!1;return()=>{a||(a=!0,setTimeout(()=>{a=!1,e()},s))}}async function v(){if(!d||!f)return;const{margins:e,canvasWidth:s,canvasHeight:a,visibleStartTimeSec:t,visibleEndTimeSec:o,hoveredUnitId:u,selectedUnitIds:l,zoomInRequired:i,infoMessage:m}=f;d.width=s,d.height=a;const r=d.getContext("2d");if(!r)return;if(r.clearRect(0,0,s,a),m&&(r.fillStyle="red",r.textAlign="center",r.textBaseline="top",r.font="20px Arial",r.fillText(m,s/2,0)),i){r.fillStyle="pink",r.textAlign="center",r.textBaseline="middle",r.font="20px Arial",r.fillText("Zoom in (mouse-wheel) to view raster plot",s/2,a/2);return}if(!h){r.fillStyle="gray",r.textAlign="center",r.textBaseline="middle",r.font="20px Arial",r.fillText("Loading...",s/2,a/2);return}const c=h.plots.length,b=n=>a-e.bottom-(n+.5-0)/(c-0)*(a-e.top-e.bottom),S=n=>e.left+(n-t)/(o-t)*(s-e.left-e.right),k=h.plots.map((n,A)=>({y:b(A),x:n.spikeTimesSec.map(I=>S(I)),unitId:n.unitId,color:n.color,hovered:n.unitId===u,selected:l.includes(n.unitId)}));T(r,k)}const g=y(v,10),T=(e,s)=>{if(!f)return;const{margins:a,canvasWidth:t,canvasHeight:o}=f;e.clearRect(0,0,t,o);const u=o/s.length;for(const l of[1,2,3])s.forEach(i=>{(l===1&&u>=10||l===2&&i.selected||l===3&&i.hovered)&&(e.fillStyle=l===1?i.color:l===2?"black":i.color,e.textAlign="right",e.textBaseline="middle",e.font=`${l>1?"bold ":""}12px Arial`,e.fillText(i.unitId+"",a.left-4,i.y),(l===3||l===2&&i.hovered)&&(e.textAlign="left",e.textBaseline="middle",e.font=`${l>1?"bold ":""}12px Arial`,e.fillText(i.unitId+"",t-a.right+4,i.y)))});e.save(),e.beginPath(),e.rect(a.left,a.top,t-a.left-a.right,o-a.top-a.bottom),e.clip();for(const l of[1,2])s.forEach(i=>{l===2&&i.hovered&&(e.strokeStyle="yellow",e.lineWidth=3,e.beginPath(),e.moveTo(0,i.y),e.lineTo(t,i.y),e.stroke(),e.strokeStyle="gray",e.lineWidth=1,e.beginPath(),e.moveTo(0,i.y),e.lineTo(t,i.y),e.stroke()),l===1&&i.selected&&(e.strokeStyle="lightblue",e.lineWidth=3,e.beginPath(),e.moveTo(0,i.y),e.lineTo(t,i.y),e.stroke())});s.forEach(l=>{e.strokeStyle=l.color,e.lineWidth=Math.max(3,Math.min(20,u/2)),e.beginPath(),l.x.forEach(i=>{e.moveTo(i-2,l.y),e.lineTo(i+2,l.y)}),e.stroke()}),e.restore()}})();
